---
title: "Go 垃圾回收原理"
date: 2024-12-17T00:00:00+08:00
categories: ["go"]
tags: ["go", "gc", "memory"]
---

Go 语言使用三色标记清除算法实现垃圾回收。本文详细介绍 GC 的工作原理。

<!--more-->

## GC 算法

Go 使用的是**并发三色标记清除算法**。

### 三色标记

- **白色**：未被访问的对象
- **灰色**：已访问但其引用未被扫描的对象
- **黑色**：已访问且其引用已被扫描的对象

### 标记过程

1. 初始时所有对象都是白色
2. 从根对象开始，将其标记为灰色
3. 从灰色对象队列中取出对象，将其引用的对象标记为灰色，自己变为黑色
4. 重复步骤 3，直到没有灰色对象
5. 清除所有白色对象

## 写屏障

为了保证并发标记的正确性，Go 使用了**混合写屏障**：

```go
writePointer(slot, ptr):
    shade(*slot)  // 对旧值进行标记
    shade(ptr)    // 对新值进行标记
    *slot = ptr
```

## GC 触发时机

1. **定时触发**：默认 2 分钟
2. **内存分配触发**：当堆内存达到上次 GC 后的 2 倍时
3. **手动触发**：调用 `runtime.GC()`

## GC 优化建议

1. 减少对象分配
2. 使用对象池复用对象
3. 避免频繁创建临时对象
4. 合理设置 GOGC 参数

## 总结

Go 的 GC 设计在吞吐量和延迟之间取得了很好的平衡，对大多数应用来说已经足够好了。
